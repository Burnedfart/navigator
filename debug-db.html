<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB Debug Tool</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        h1 {
            color: #4ec9b0;
        }

        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background: #1177bb;
        }

        .output {
            background: #252526;
            border: 1px solid #3e3e42;
            padding: 15px;
            margin-top: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        .error {
            color: #f48771;
        }

        .success {
            color: #4ec9b0;
        }

        .warn {
            color: #dcdcaa;
        }
    </style>
</head>

<body>
    <h1>üîç IndexedDB Debugger</h1>

    <div>
        <button onclick="listAllDatabases()">List All Databases</button>
        <button onclick="inspectBareMux()">Inspect BareMux DB</button>
        <button onclick="deleteBareMuxDB()">Delete BareMux DB</button>
        <button onclick="checkServiceWorker()">Check Service Worker</button>
        <button onclick="unregisterSW()">Unregister Service Worker</button>
        <button onclick="clearAll()">Clear Everything</button>
    </div>

    <div id="output" class="output">Ready. Click a button to start debugging...</div>

    <script>
        const output = document.getElementById('output');

        function log(msg, type = 'info') {
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warn' ? 'warn' : '';
            output.innerHTML += `<div class="${className}">${msg}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function clear() {
            output.innerHTML = '';
        }

        async function listAllDatabases() {
            clear();
            log('üìã LISTING ALL DATABASES...', 'info');
            try {
                const databases = await indexedDB.databases();
                log(`\nFound ${databases.length} database(s):\n`, 'success');
                databases.forEach(db => {
                    log(`  ‚Ä¢ ${db.name} (v${db.version})`);
                });
            } catch (err) {
                log(`Error: ${err.message}`, 'error');
            }
        }

        async function inspectBareMux() {
            clear();
            log('üîé INSPECTING BareMux DATABASE...', 'info');

            return new Promise((resolve) => {
                const request = indexedDB.open('BareMux');

                request.onsuccess = (event) => {
                    const db = event.target.result;
                    log(`\n‚úÖ Database Version: ${db.version}`, 'success');
                    log(`\nObject Stores (${db.objectStoreNames.length}):`);

                    for (let i = 0; i < db.objectStoreNames.length; i++) {
                        log(`  ‚Ä¢ ${db.objectStoreNames[i]}`);
                    }

                    // Try to read from 'config' store if it exists
                    if (db.objectStoreNames.contains('config')) {
                        const transaction = db.transaction(['config'], 'readonly');
                        const store = transaction.objectStore('config');
                        const getAllRequest = store.getAll();

                        getAllRequest.onsuccess = () => {
                            log(`\nüì¶ Config Store Contents:`, 'success');
                            log(JSON.stringify(getAllRequest.result, null, 2));
                        };
                    } else {
                        log(`\n‚ö†Ô∏è 'config' object store NOT FOUND!`, 'warn');
                        log('This is the problem! BareMux expects a "config" store.', 'warn');
                    }

                    db.close();
                    resolve();
                };

                request.onerror = (event) => {
                    log(`‚ùå Error opening database: ${event.target.error}`, 'error');
                    resolve();
                };

                request.onupgradeneeded = (event) => {
                    log(`üîÑ Database upgrade triggered (creating fresh DB)`, 'warn');
                    log(`Old version: ${event.oldVersion}, New version: ${event.newVersion}`);
                };
            });
        }

        async function deleteBareMuxDB() {
            clear();
            log('üóëÔ∏è DELETING BareMux DATABASE...', 'warn');

            return new Promise((resolve) => {
                const request = indexedDB.deleteDatabase('BareMux');

                request.onsuccess = () => {
                    log('\n‚úÖ BareMux database deleted successfully!', 'success');
                    log('Reload the page to reinitialize.', 'info');
                    resolve();
                };

                request.onerror = (event) => {
                    log(`‚ùå Error deleting database: ${event.target.error}`, 'error');
                    resolve();
                };

                request.onblocked = () => {
                    log('‚ö†Ô∏è Delete blocked! Close all tabs using this database.', 'warn');
                    resolve();
                };
            });
        }

        async function checkServiceWorker() {
            clear();
            log('üîß CHECKING SERVICE WORKER...', 'info');

            if (!('serviceWorker' in navigator)) {
                log('‚ùå Service Workers not supported!', 'error');
                return;
            }

            const registrations = await navigator.serviceWorker.getRegistrations();
            log(`\nFound ${registrations.length} registration(s):\n`, 'success');

            registrations.forEach((reg, idx) => {
                log(`Registration #${idx + 1}:`);
                log(`  Scope: ${reg.scope}`);
                log(`  Active: ${reg.active ? '‚úÖ Yes' : '‚ùå No'}`);
                log(`  Installing: ${reg.installing ? '‚è≥ Yes' : 'No'}`);
                log(`  Waiting: ${reg.waiting ? '‚è≥ Yes' : 'No'}`);
                if (reg.active) {
                    log(`  Script URL: ${reg.active.scriptURL}`);
                    log(`  State: ${reg.active.state}`);
                }
                log('');
            });
        }

        async function unregisterSW() {
            clear();
            log('üßπ UNREGISTERING ALL SERVICE WORKERS...', 'warn');

            const registrations = await navigator.serviceWorker.getRegistrations();

            for (let registration of registrations) {
                const result = await registration.unregister();
                log(`${result ? '‚úÖ' : '‚ùå'} Unregistered: ${registration.scope}`, result ? 'success' : 'error');
            }

            log('\n‚úÖ Complete! Reload the page to re-register.', 'success');
        }

        async function clearAll() {
            clear();
            log('üí£ CLEARING EVERYTHING...', 'warn');

            // Delete BareMux DB
            await deleteBareMuxDB();

            // Unregister service workers
            log('\nüßπ Unregistering service workers...', 'info');
            await unregisterSW();

            // Clear caches
            log('\nüóëÔ∏è Clearing caches...', 'info');
            const cacheNames = await caches.keys();
            for (let name of cacheNames) {
                await caches.delete(name);
                log(`  ‚úÖ Deleted cache: ${name}`);
            }

            log('\n‚úÖ ALL CLEARED! Reload to start fresh.', 'success');
        }
    </script>
</body>

</html>